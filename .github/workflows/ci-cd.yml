# ci-cd workflow to run tests and deploy the app to production
name: CI/CD Pipeline

on:
  push:
    branches:
      - main  # Triggers on push to the main branch
  pull_request:
    branches:
      - main  # Triggers on pull requests to the main branch

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      # Check out the code
      - name: Checkout Code
        uses: actions/checkout@v3

      # Set up Python
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'  # Adjust based on your project

      # Install Dependencies
      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # Run Tests
      - name: Run Tests
        run: |
          pytest  # Assumes you're using pytest; replace if needed

  deploy:
    needs: test  # Run only if tests succeed
    runs-on: ubuntu-latest

    steps:
      # Check out the code
      - name: Checkout Code
        uses: actions/checkout@v3

      # Login to Docker
      - name: Log in to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # Build Docker Image
      - name: Build Docker Image
        run: |
          docker build -t your-docker-username/your-repo-name:latest .

      # Push Docker Image to Docker Hub
      - name: Push Docker Image
        run: |
          docker push your-docker-username/your-repo-name:latest

      # Deploy to Google Cloud Run (or another platform)
      - name: Deploy to Google Cloud Run
        env:
          GOOGLE_APPLICATION_CREDENTIALS: ${{ secrets.GOOGLE_CREDENTIALS }}
        run: |
          gcloud auth activate-service-account --key-file=$GOOGLE_APPLICATION_CREDENTIALS
          gcloud run deploy your-service-name \
            --image your-docker-username/your-repo-name:latest \
            --region your-region \
            --platform managed \
            --allow-unauthenticated
